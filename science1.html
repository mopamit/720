<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ממשק צפייה במשאבי מדעים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
        }
        .iframe-container {
            position: relative;
            width: 100%;
            height: 60vh;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for metadata */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 flex flex-col gap-6 h-screen">
        
        <!-- Header & Controls -->
        <header class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto order-2 md:order-1">
                <button id="btnPrev" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    הקודם
                </button>
                <div class="text-center md:text-right flex-1 min-w-[100px]">
                    <span id="counter" class="text-sm text-gray-500 font-mono">טוען...</span>
                </div>
                <button id="btnNext" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    הבא
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
            </div>
            <div class="flex-1 w-full md:w-auto text-center md:text-left order-1 md:order-2">
                 <h1 id="mainHeaderTitle" class="text-xl font-bold text-gray-800 truncate">טוען כותרת...</h1>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="mainContent" class="hidden flex-1 flex flex-col gap-4">
            
            <!-- Metadata Top (Simplified as Title is now in header) -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                    <div class="flex-1">
                         <div class="flex items-center gap-2 mb-2">
                            <span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2.5 py-0.5 rounded border border-indigo-200">ID: <span id="itemId"></span></span>
                        </div>
                        <h2 id="itemTitle" class="text-lg font-bold text-gray-900 mb-1 leading-tight hidden"></h2> <!-- Hidden as moved to header, keeping for ref if needed -->
                        <p id="itemDesc" class="text-gray-600 text-base leading-relaxed"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full min-h-0">
                <!-- Iframe -->
                <div class="lg:col-span-2 flex flex-col h-full min-h-0">
                    <div class="iframe-container bg-gray-50 flex items-center justify-center relative flex-1">
                        <div id="iframePlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-400 z-0">
                            <span class="flex flex-col items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="12" cy="12" r="5"></circle><path d="M12 12V2"></path></svg>
                                טוען תצוגה מקדימה...
                            </span>
                        </div>
                        <iframe id="contentFrame" src="" class="z-10 bg-white" sandbox="allow-forms allow-scripts allow-same-origin allow-popups"></iframe>
                    </div>
                    
                    <!-- New Window Button (Replacing text) -->
                    <div class="mt-3 text-center">
                        <a id="externalLinkBtn" href="#" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                            התוכן לא מוצג? לחץ כאן לפתיחה בחלון חדש
                        </a>
                    </div>
                </div>

                <!-- Metadata Sidebar -->
                <div class="lg:col-span-1 bg-white p-5 rounded-lg shadow-sm border border-gray-200 overflow-y-auto max-h-[60vh] lg:max-h-full scrollbar-thin">
                    <h3 class="font-bold text-gray-800 mb-4 pb-2 border-b sticky top-0 bg-white">פרטים נוספים</h3>
                    <div id="metadataList" class="space-y-4">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Loading State -->
        <div id="loading" class="flex-1 flex flex-col items-center justify-center text-center">
            <div class="loader"></div>
            <p class="text-gray-600 font-medium">טוען נתונים, אינדקסים ותרגומים...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden flex-1 flex flex-col items-center justify-center text-center text-red-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-4"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <p id="errorMessage" class="font-bold">שגיאה בטעינת הנתונים</p>
        </div>

    </div>

    <script>
        // --- Configuration ---
        const DATA_SHEET_ID = '1YKIfh8tMXnp83DQoNRQMGEH61qNbukyqbskufQXKRrY';
        const DATA_GID = '192441212'; // JSON SCIENCE
        
        // Indices
        // Science/Subtopic Index (Existing - kept as fallback)
        const SCIENCE_INDEX_ID = '1gqeucmOSQIi565kIoG1hUzOpT4VOriz6ehJfBbc8Ndo';
        const SCIENCE_GID = '0'; 
        
        // Skills Index (External - kept as fallback)
        const SKILLS_INDEX_ID = '1FlAzcibPOItnXUyTgN7Jmb-Kzm006K54qkrTNX7cdUQ';
        const SKILLS_GID = '1661050144'; 

        // Field Translations Sheet
        const KEYS_SHEET_ID = '12PT72SuTLmt_ayAibMk9r4bEHrFUY10XCvFyc8605Eg';
        const KEYS_GID = '911902053';

        // --- MAPPING DICTIONARIES ---

        // 1. Field Names (Keys) -> Hebrew Labels
        const FIELD_LABELS = {
            'title': 'כותרת',
            'description': 'תיאור',
            'contenttype': 'סוג תוכן',
            'subject': 'תחום דעת',
            'gradelevel': 'גיל',
            'topic': 'שם נושא',
            'subtopic': 'נושא ידע',
            'prerequisitesubtopics': 'נושאי ידע מקדימים',
            'skills': 'מיומנויות',
            'manufacture': 'יצרן תוכן',
            'priorbasedpractice': 'ידע מקדים',
            'targetsector': 'אוכלוסיית יעד',
            'targetaudience': 'קהל יעד',
            'relativedifficulty': 'רמת קושי',
            'depthlevel': 'רמת עומק',
            'cognitivelevel': 'רמת חשיבה',
            'languages': 'שפה',
            'estimatedtimeinminutes': 'משך צפוי ללמידה'
        };

        // 2. Value Translations (Content)
        const VALUE_MAPS = {
            'targetsector': {
                'State (General)': 'ממלכתי',
                'State (Religious)': 'ממלכתי דתי',
                'Druze': 'דרוזי',
                'Special Education': 'חנ"מ',
                'Orthodox': 'ממלכתי חרדי'
            },
            'targetaudience': {
                'General': 'כללי',
                'Excellent': 'מצוינות',
                'Disadvantaged Populations': 'אוכלוסיות מוחלשות',
                'Students with Special Needs': 'צרכים מיוחדים',
                'At Risk Students': 'תלמידים בסיכון'
            },
            'depthlevel': {
                'Core Curriculum Basic': 'בסיסי',
                'Advanced': 'מתקדם',
                'Enrichment': 'העשרה'
            },
            'cognitivelevel': {
                'Remember': 'זכירה',
                'Understand': 'הבנה',
                'Apply': 'יישום',
                'Analyze': 'ניתוח',
                'Evaluate': 'הערכה',
                'Create': 'יצירה'
            },
            'languages': {
                'Hebrew': 'עברית',
                'English': 'אנגלית',
                'Arabic': 'ערבית'
            }
        };

        // --- SKILLS DICTIONARY ---
        const SKILLS_DICTIONARY = {
            'MOE.STEM.SCIENTIFIC.LITSCI-CONCEPTS.001': 'הבנת מושגים, תופעות ומונחים',
            'MOE.STEM.SCIENTIFIC.LITSCI-APPLY.002': 'יישום מושגים מדעיים בהקשרים מגוונים',
            'MOE.STEM.SCIENTIFIC.EXPLAIN-EVIDENCE.001': 'בניית הסברים מבוססי ראיות',
            'MOE.STEM.SCIENTIFIC.EXPLAIN-DESCRIBE.002': 'תיאור תופעות במונחים מדעיים',
            'MOE.STEM.SCIENTIFIC.INQUIRY-DESIGN.001': 'תכנון חקר וזיהוי משתנים',
            'MOE.STEM.SCIENTIFIC.INQUIRY-VALIDATE.002': 'הערכת איכות ומהימנות של המחקר',
            'MOE.STEM.SCIENTIFIC.ANALYZE-PATTERNS.001': 'ניתוח נתונים וזיהוי דפוסים',
            'MOE.STEM.SCIENTIFIC.ANALYZE-INFER.002': 'גזירת מסקנות מבוססות ראיות',
            'MOE.STEM.SCIENTIFIC.COMM-PRESENT.001': 'הצגת ממצאים בצורה ברורה',
            'MOE.STEM.SCIENTIFIC.COMM-ARGUE.002': 'נימוק טענות על בסיס ראיות',
            'MOE.STEM.SCIENTIFIC.EVALINFO-SOURCES.001': 'בחינת אמינות ואיכות של מידע מדעי',
            'MOE.STEM.SCIENTIFIC.EVALINFO-DECIDE.002': 'שימוש במידע לקבלת החלטות',
            'MOE.STEM.SCIENTIFIC.CREATE-INNOVATE.001': 'פיתוח רעיונות, ניסויים ופתרונות חדשים',
            'MOE.STEM.SCIENTIFIC.CRIT-EVALUATE.001': 'בחינת טענות וזיהוי הטיות',
            'MOE.STEM.SCIENTIFIC.CRIT-STRENGTH.002': 'הערכת חוזק מסקנות',
            'MOE.STEM.SCIENTIFIC.PROBLEM-APPLY.001': 'יישום חשיבה מדעית לפתרון בעיות',
            'MOE.STEM.CROSS.COMPUTE-DECOMPOSE.001': 'פירוק בעיות',
            'MOE.STEM.CROSS.COMPUTE-ALGO.002': 'בניית אלגוריתמים',
            'MOE.STEM.CROSS.INFO-FILTER.001': 'איתור והערכה',
            'MOE.STEM.CROSS.INFO-REPRESENT.002': 'ייצוג ופרשנות',
            'MOE.STEM.CROSS.VALUE-INNOVATE.001': 'יצירת רעיונות',
            'MOE.STEM.CROSS.VALUE-INTEGRATE.002': 'אינטגרציה של ידע',
            'MOE.STEM.CROSS.SELF-MANAGE.001': 'ניהול למידה',
            'MOE.STEM.CROSS.SELF-DECIDE.002': 'קבלת החלטות',
            'MOE.STEM.CROSS.SOCIAL-COLLAB.001': 'תקשורת ושיתוף פעולה',
            'MOE.STEM.CROSS.SOCIAL-RESOLVE.002': 'פתרון קונפליקטים'
        };

        // --- MOE DICTIONARY ---
        const MOE_DICTIONARY = {
            'CHEM': 'כימיה',
            'PHY': 'פיזיקה',
            'BIO': 'ביולוגיה',
            'EARTH': 'מדעי כדור הארץ והסביבה',
            'TECH': 'טכנולוגיה',
            'MEAS': 'מידות ומדידות',
            'GAS': 'גזים והאוויר',
            'MATL': 'חומרים והשפעתם',
            'PHASE': 'מצבי צבירה',
            'PART': 'מודל החלקיקים',
            'ENRG': 'אנרגיה',
            'CONS': 'חוקי שימור',
            'LIFE': 'מאפייני החיים',
            'ORG': 'רמות ארגון',
            'CELL': 'התא',
            'TRANS': 'הובלה באדם', 
            'BLOOD': 'מערכת הדם',
            'HEAL': 'בריאות ואיכות חיים',
            'PLANT': 'מים בצמח',
            'ECO': 'מערכות אקולוגיות',
            'DES': 'תהליך התיכון',
            'IMPT': 'השפעת הטכנולוגיה',
            'VOL': 'נפח',
            'MASS': 'מסה',
            'WEIGHT': 'משקל',
            'UNIT': 'יחידות מידה',
            'STATE': 'מצב צבירה',
            'POINT': 'נקודת התכה/רתיחה',
            'RATE': 'קצב',
            'DIFF': 'פעפוע',
            'PRESS': 'לחץ',
            'AIR': 'הרכב האוויר',
            'OXY': 'חמצן',
            'CO2': 'פחמן דו-חמצני',
            'GREEN': 'אפקט החממה',
            'ENV': 'סביבה',
            'SUST': 'קיימות',
            'TYPE': 'סוגי אנרגיה',
            'CONV': 'המרת אנרגיה',
            'FLOW': 'מעבר אנרגיה',
            'DISS': 'פיזור אנרגיה',
            'SYSTEM': 'מערכת',
            'FUNC': 'מאפייני חיים',
            'NEED': 'צרכים חיוניים', 
            'HIER': 'רמות ארגון',
            'MICRO': 'מיקרוסקופ',
            'STRUCT': 'מבנה',
            'PLANTCELL': 'תא צמח',
            'MAT': 'הובלת חומרים',
            'SYSFUNC': 'תפקודי מערכת',
            'HEART': 'לב',
            'VESSEL': 'כלי דם',
            'COMP': 'מרכיבים',
            'HB': 'המוגלובין',
            'IMM': 'חיסון',
            'CLOT': 'קרישת דם',
            'RISK': 'גורמי סיכון',
            'PREV': 'מניעה',
            'OSM': 'אוסמוזה',
            'TRANSP': 'דיות',
            'WILT': 'כמישה',
            'INTER': 'יחסי גומלין',
            'CLIM': 'שינויי אקלים',
            'SCIRELS': 'מדע וטכנולוגיה',
            'CONST': 'אילוצים',
            'PLAN': 'תכנון',
            'EXEC': 'ביצוע',
            'PRES': 'הצגה',
            'COLLAB': 'שיתופיות',
            'ENVIMP': 'השפעה סביבתית'
        };

        // --- State ---
        let mainData = [];
        let scienceIndex = {}; 
        let skillsIndex = {};
        let keyTranslationMap = {}; // Kept for backward compatibility if needed, but FIELD_LABELS is primary
        let currentIndex = 0;

        // Keys to ignore completely (Hidden from user)
        const IGNORED_KEYS = ['questiontype', 'wiifm'];

        // --- Helper: Fetch Google Sheet Data via Gviz ---
        async function fetchSheetData(sheetId, gid) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq&gid=${gid}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                
                const jsonString = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonString);
                
                return processGvizTable(json.table);
            } catch (error) {
                console.error('Error fetching sheet:', error);
                throw error;
            }
        }

        function processGvizTable(table) {
            const headers = table.cols.map(col => col.label || 'Unknown');
            
            return table.rows.map(row => {
                const item = {};
                row.c.forEach((cell, index) => {
                    const header = headers[index];
                    let value = cell ? (cell.v !== null ? cell.v : '') : '';
                    item[header] = value;
                });
                return item;
            });
        }

        // --- Helper: Build Index Maps ---
        function buildIndexMap(data) {
            const map = {};
            data.forEach(row => {
                const keys = Object.keys(row);
                let codeKey = keys.find(k => k.toLowerCase().includes('code') || k.includes('קוד') || k.toLowerCase().includes('id')) || keys[0];
                let valKey = keys.find(k => (k !== codeKey) && (k.includes('שם') || k.includes('Name') || k.includes('hebrew') || k.includes('עברית'))) || keys[1];
                
                if (row[codeKey]) {
                    map[row[codeKey]] = row[valKey] || row[codeKey];
                }
            });
            return map;
        }

        function buildKeyTranslationMap(data) {
            const map = {};
            data.forEach(row => {
                const keys = Object.keys(row);
                const enKey = row[keys[0]]; 
                const heVal = row[keys[1]];
                if (enKey && heVal) {
                    map[enKey.toLowerCase().trim()] = heVal;
                }
            });
            return map;
        }

        // --- Helper: Translate MOE Codes ---
        function translateMoeCode(code) {
            if (!code) return code;
            code = code.trim();

            if (code === 'TRANS') return 'מעבר מצב צבירה/הובלה באדם';
            if (MOE_DICTIONARY[code]) return MOE_DICTIONARY[code];

            if (code.startsWith('MOE.')) {
                const parts = code.split('.');
                if (parts.length >= 5) {
                    const domCode = parts[3];
                    const topSub = parts[4]; 
                    
                    let translatedParts = [];
                    
                    if (MOE_DICTIONARY[domCode]) translatedParts.push(MOE_DICTIONARY[domCode]);

                    if (topSub.includes('-')) {
                        const [topCode, subCode] = topSub.split('-');
                        if (MOE_DICTIONARY[topCode]) translatedParts.push(MOE_DICTIONARY[topCode]);
                        if (subCode === 'TRANS') translatedParts.push('מעבר מצב צבירה');
                        else if (MOE_DICTIONARY[subCode]) translatedParts.push(MOE_DICTIONARY[subCode]);
                        else translatedParts.push(subCode);
                    } else {
                         if (MOE_DICTIONARY[topSub]) translatedParts.push(MOE_DICTIONARY[topSub]);
                    }

                    if (translatedParts.length > 0) {
                        return translatedParts.join(' > ');
                    }
                }
            }
            
            if (scienceIndex[code]) return scienceIndex[code];

            return code;
        }

        // --- Initialization ---
        async function init() {
            try {
                const [rawData, rawScience, rawSkills, rawKeys] = await Promise.all([
                    fetchSheetData(DATA_SHEET_ID, DATA_GID),
                    fetchSheetData(SCIENCE_INDEX_ID, SCIENCE_GID),
                    fetchSheetData(SKILLS_INDEX_ID, SKILLS_GID),
                    fetchSheetData(KEYS_SHEET_ID, KEYS_GID)
                ]);

                mainData = rawData.filter(row => {
                    const keys = Object.keys(row);
                    return keys.some(k => row[k] && row[k].toString().trim() !== '');
                });

                scienceIndex = buildIndexMap(rawScience);
                skillsIndex = buildIndexMap(rawSkills);
                keyTranslationMap = buildKeyTranslationMap(rawKeys);

                if (mainData.length === 0) {
                    throw new Error("לא נמצאו נתונים בגליון הראשי");
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                setupEventListeners();
                renderCurrentItem();

            } catch (err) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = 'שגיאה בטעינה: ' + err.message;
            }
        }

        // --- Rendering ---
        function renderCurrentItem() {
            if (mainData.length === 0) return;
            
            const item = mainData[currentIndex];
            const keys = Object.keys(item);

            const idKey = keys.find(k => k.toLowerCase().includes('id') || k.includes('מזהה')) || keys[0];
            const titleKey = keys.find(k => k.toLowerCase().includes('title') || k.includes('שם')) || keys[1];
            const linkKey = keys.find(k => k.toLowerCase().includes('link') || k.toLowerCase().includes('url') || k.includes('קישור')) || keys[2];
            const descKey = keys.find(k => k.toLowerCase().includes('desc') || k.includes('תיאור')) || keys[3];

            document.getElementById('itemId').textContent = item[idKey] || '-';
            
            const currentTitle = item[titleKey] || 'ללא כותרת';
            document.getElementById('mainHeaderTitle').textContent = currentTitle;
            document.title = currentTitle; 
            
            document.getElementById('itemDesc').textContent = item[descKey] || '';
            document.getElementById('counter').textContent = `פריט ${currentIndex + 1} מתוך ${mainData.length}`;

            const link = item[linkKey];
            const iframe = document.getElementById('contentFrame');
            const extLinkBtn = document.getElementById('externalLinkBtn');
            
            if (link && link.startsWith('http')) {
                let embedLink = link;
                if (link.includes('youtube.com/watch')) {
                    embedLink = link.replace('watch?v=', 'embed/');
                }
                iframe.src = embedLink;
                extLinkBtn.href = link;
                extLinkBtn.classList.remove('pointer-events-none', 'opacity-50');
                extLinkBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    התוכן לא מוצג? לחץ כאן לפתיחה בחלון חדש
                `;
            } else {
                iframe.src = 'about:blank';
                extLinkBtn.href = '#';
                extLinkBtn.classList.add('pointer-events-none', 'opacity-50');
                extLinkBtn.textContent = 'אין קישור זמין';
            }

            const metadataList = document.getElementById('metadataList');
            metadataList.innerHTML = ''; 

            keys.forEach(key => {
                // Skip Title, Desc, Link, ID from the list as they are displayed in main area
                if ([idKey, titleKey, linkKey, descKey].includes(key)) return;
                
                const rawValue = item[key];
                if (!rawValue || rawValue.toString().trim() === '') return;

                const normalizedKey = key.toLowerCase().trim();
                
                // 1. Check if ignored (Hidden)
                if (IGNORED_KEYS.includes(normalizedKey)) return;

                // 2. Translate Key (Label)
                const displayLabel = FIELD_LABELS[normalizedKey] || keyTranslationMap[normalizedKey] || key;

                let displayValue = rawValue;
                
                // --- VALUE MAPPING LOGIC ---
                
                // A. Skills and Subtopics (Specific Logic)
                const isSkills = normalizedKey.includes('skills') || displayLabel.includes('מיומנויות');
                const isSubtopics = normalizedKey.includes('subtopic') || displayLabel.includes('נושא ידע'); // Covers 'subtopic' and 'prerequisiteSubTopics'

                if (isSkills || isSubtopics) {
                     const parts = String(rawValue).split(',').map(p => p.trim());
                     const mappedParts = parts.map(part => {
                        let translated = part;
                        
                        if (isSkills) {
                            if (SKILLS_DICTIONARY[part]) translated = SKILLS_DICTIONARY[part];
                            else if (skillsIndex[part]) translated = skillsIndex[part];
                        } else if (isSubtopics) {
                            translated = translateMoeCode(part);
                        }
                        
                        if (translated !== part) {
                            return `<span class="inline-block bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs font-semibold border border-blue-100 mr-1 mb-1">${translated}</span>`;
                        }
                        return part;
                    });
                    displayValue = mappedParts.join(' '); 
                } 
                // B. Value Maps (Generic Lookups)
                else if (VALUE_MAPS[normalizedKey]) {
                    const parts = String(rawValue).split(',').map(p => p.trim());
                    const mappedParts = parts.map(part => {
                        return VALUE_MAPS[normalizedKey][part] || part;
                    });
                    displayValue = mappedParts.join(', ');
                }

                const div = document.createElement('div');
                div.className = "border-b border-gray-100 pb-3 last:border-0";
                div.innerHTML = `
                    <div class="text-gray-500 text-xs font-medium mb-1 uppercase tracking-wider">${displayLabel}</div>
                    <div class="text-gray-800 text-sm leading-relaxed">${displayValue}</div>
                `;
                metadataList.appendChild(div);
            });
            
            document.getElementById('btnPrev').disabled = currentIndex === 0;
            document.getElementById('btnNext').disabled = currentIndex === mainData.length - 1;
        }

        function setupEventListeners() {
            document.getElementById('btnPrev').addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    renderCurrentItem();
                }
            });

            document.getElementById('btnNext').addEventListener('click', () => {
                if (currentIndex < mainData.length - 1) {
                    currentIndex++;
                    renderCurrentItem();
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') { 
                    if (currentIndex < mainData.length - 1) {
                         currentIndex++;
                         renderCurrentItem();
                    }
                }
                if (e.key === 'ArrowRight') {
                    if (currentIndex > 0) {
                         currentIndex--;
                         renderCurrentItem();
                    }
                }
            });
        }

        init();
    </script>
</body>
</html>
